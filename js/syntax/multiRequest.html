<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
</head>
<body>
<script>
	const wait = () => {
		return new Promise((resolve) => {
			setTimeout(resolve, 1000 * Math.random());
		})
	} 
		
	
	const multiRequest = (urls, max = 1) => {
		return new Promise((resolve, reject) => {
			let rest = urls.slice();
			let finished = 0;
			let currentIndex = 0;
			let res = [];

			const request = async (idx) => {
				if(rest.length === 0) return;

				//维护本次请求对应数组的下标
				currentIndex++;
				const url = rest.shift();
				try {
					await wait();
				}catch (error) {
					reject(error);
				}
				console.log('res',res);
				res[idx] = url;

				//请求
				finished++;
				if(finished === urls.length) return resolve(res);

				//没请求完递归
				request(currentIndex);
			}

			for(let i=0; i<max; i++) {
				request(i);
			}

		})
	}

	console.log(
	  multiRequest(["1", "2", "3", "4", "5", 6, 7, 8, 9, 10], 3).then((res) =>
	    console.log("res", res),
	  ),
	)

	class eventEmitter {
		constructor() {
			this.events = {};
		}
		on(eventName, callback) {
			if(!this.events[eventName]) {
				this.events[eventName] = [callback];
			}else {
				this.events[eventName].push([callback]);
			}
		}
		emit(eventName) {
			this.events[eventName] && this.events[eventName].forEach(fn => fn());
		}
	}
</script>
</body>
</html>